{% extends 'base.html' %}
{% load static %}

{% block title %}{{ entreprise.nom_entreprise }} - Questionnaires{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'questionnaires/css/voir_questionnaire.css' %}">
{% endblock %}

{% block content %}
<div class="voir-questionnaire-container">
    <div class="header-card card">
        <h1>{{ entreprise.nom_entreprise }}</h1>
        <p class="siren-info"><strong>SIREN :</strong> {{ entreprise.siren }}</p>
        <p class="date-info">
            <small>
                Cr√©√© le {{ entreprise.date_creation|date:"d/m/Y √† H:i" }} -
                Modifi√© le {{ entreprise.date_modification|date:"d/m/Y √† H:i" }}
            </small>
        </p>
    </div>

    <!-- Onglets -->
    <div class="tabs-container card">
        <div class="tabs">
            {% if has_client %}
            <button class="tab-btn active" onclick="showTab('client')">
                Questionnaire Client
            </button>
            {% endif %}

            {% if has_collaborateur %}
            <button class="tab-btn {% if not has_client %}active{% endif %}" onclick="showTab('collaborateur')">
                Questionnaire Collaborateur
            </button>
            {% endif %}

            {% if has_client and has_collaborateur %}
            <button class="tab-btn" onclick="showTab('synthese')">
                Vue Synth√©tique
            </button>
            {% endif %}
        </div>

        <!-- Contenu Questionnaire Client -->
        {% if has_client %}
        <div id="tab-client" class="tab-content active">
            <h2>Questionnaire Client</h2>
            <p class="meta-info">
                <small>
                    Compl√©t√© le {{ questionnaire_client.date_completion|date:"d/m/Y √† H:i" }}
                    {% if questionnaire_client.modifie_par_collaborateur %}
                    - Modifi√© par {{ questionnaire_client.modifie_par_collaborateur.get_full_name }}
                    {% endif %}
                </small>
            </p>

            <div class="questionnaire-section">
                <h3>√âquipement actuel</h3>
                <dl>
                    <dt>Logiciel de facturation</dt>
                    <dd>{{ questionnaire_client.logiciel_facturation|yesno:"Oui,Non" }}
                        {% if questionnaire_client.logiciel_facturation_nom %}
                        - {{ questionnaire_client.logiciel_facturation_nom }}
                        {% endif %}
                    </dd>

                    <dt>Factures au format √©lectronique</dt>
                    <dd>{{ questionnaire_client.get_factures_format_electronique_display|default:"Non renseign√©" }}</dd>

                    <dt>Logiciel de devis</dt>
                    <dd>{{ questionnaire_client.logiciel_devis|yesno:"Oui,Non" }}
                        {% if questionnaire_client.logiciel_devis_nom %}
                        - {{ questionnaire_client.logiciel_devis_nom }}
                        {% endif %}
                    </dd>

                    <dt>Caisse enregistreuse</dt>
                    <dd>{{ questionnaire_client.get_caisse_enregistreuse_display|default:"Non renseign√©" }}
                        {% if questionnaire_client.caisse_enregistreuse_nom %}
                        - {{ questionnaire_client.caisse_enregistreuse_nom }}
                        {% endif %}
                    </dd>

                    <dt>Caisse certifi√©e</dt>
                    <dd>{{ questionnaire_client.get_caisse_certifiee_display|default:"Non renseign√©" }}</dd>

                    <dt>Plateforme agr√©√©e</dt>
                    <dd>{{ questionnaire_client.get_plateforme_agreee_display|default:"Non renseign√©" }}
                        {% if questionnaire_client.plateforme_agreee_nom %}
                        - {{ questionnaire_client.plateforme_agreee_nom }}
                        {% endif %}
                    </dd>
                </dl>
            </div>

            <div class="questionnaire-section">
                <h3>Gestion facturation</h3>
                <dl>
                    <dt>Gestion future</dt>
                    <dd>{{ questionnaire_client.get_gestion_future_display|default:"Non renseign√©" }}</dd>

                    <dt>Aisance avec les outils num√©riques</dt>
                    <dd>{{ questionnaire_client.get_aisance_outils_display|default:"Non renseign√©" }}</dd>
                </dl>
            </div>

            <div class="questionnaire-section">
                <h3>Informations compl√©mentaires</h3>
                <dl>
                    <dt>R√©ception factures achats</dt>
                    <dd>{{ questionnaire_client.get_reception_factures_achats_display|default:"Non renseign√©" }}
                        {% if questionnaire_client.reception_achats_autre %}
                        - {{ questionnaire_client.reception_achats_autre }}
                        {% endif %}
                    </dd>

                    <dt>Envoi factures ventes</dt>
                    <dd>{{ questionnaire_client.get_envoi_factures_ventes_display|default:"Non renseign√©" }}
                        {% if questionnaire_client.envoi_ventes_autre %}
                        - {{ questionnaire_client.envoi_ventes_autre }}
                        {% endif %}
                    </dd>

                    <dt>Conservation factures</dt>
                    <dd>{{ questionnaire_client.get_conservation_factures_display|default:"Non renseign√©" }}</dd>

                    <dt>Accompagnement souhait√©</dt>
                    <dd>
                        {% if questionnaire_client.accompagnement_souhaite %}
                        {{ questionnaire_client.accompagnement_souhaite|join:", " }}
                        {% if questionnaire_client.accompagnement_autre %}
                        - {{ questionnaire_client.accompagnement_autre }}
                        {% endif %}
                        {% else %}
                        Non renseign√©
                        {% endif %}
                    </dd>

                    {% if questionnaire_client.commentaires %}
                    <dt>Commentaires</dt>
                    <dd>{{ questionnaire_client.commentaires }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>
        {% endif %}

        <!-- Contenu Questionnaire Collaborateur -->
        {% if has_collaborateur %}
        <div id="tab-collaborateur" class="tab-content {% if not has_client %}active{% endif %}">
            <h2>Questionnaire Collaborateur</h2>
            <p class="meta-info">
                <small>
                    Compl√©t√© le {{ questionnaire_collaborateur.date_completion|date:"d/m/Y √† H:i" }}
                    par {{ questionnaire_collaborateur.collaborateur.get_full_name }}
                </small>
            </p>

            <div class="questionnaire-section">
                <h3>Assujettissement et activit√©</h3>
                <dl>
                    <dt>Assujettie √† la TVA</dt>
                    <dd>{{ questionnaire_collaborateur.get_assujettie_tva_display|default:"Non renseign√©" }}</dd>

                    <dt>Code APE</dt>
                    <dd>{{ questionnaire_collaborateur.code_ape|default:"Non renseign√©" }}</dd>

                    <dt>Activit√© pr√©cise</dt>
                    <dd>{{ questionnaire_collaborateur.activite_precise|default:"Non renseign√©" }}</dd>

                    <dt>Taille entreprise</dt>
                    <dd>{{ questionnaire_collaborateur.get_taille_entreprise_display|default:"Non renseign√©" }}</dd>

                    <dt>R√©gime TVA</dt>
                    <dd>{{ questionnaire_collaborateur.get_regime_tva_display|default:"Non renseign√©" }}</dd>

                    <dt>Activit√© exon√©r√©e TVA</dt>
                    <dd>{{ questionnaire_collaborateur.get_activite_exoneree_tva_display|default:"Non renseign√©" }}</dd>

                    <dt>Plateforme agr√©√©e</dt>
                    <dd>{{ questionnaire_collaborateur.plateforme_agreee|yesno:"Oui,Non" }}
                        {% if questionnaire_collaborateur.plateforme_agreee_nom %}
                        - {{ questionnaire_collaborateur.plateforme_agreee_nom }}
                        {% endif %}
                    </dd>
                </dl>
            </div>

            <div class="questionnaire-section">
                <h3>Flux facturation - Ventes</h3>
                <dl>
                    <dt>Nombre factures ventes/an</dt>
                    <dd>{{ questionnaire_collaborateur.get_nb_factures_ventes_display|default:"Non renseign√©" }}</dd>

                    <dt>Nombre clients actifs</dt>
                    <dd>{{ questionnaire_collaborateur.get_nb_clients_actifs_display|default:"Non renseign√©" }}</dd>

                    <dt>Types de ventes</dt>
                    <dd>
                        {% if questionnaire_collaborateur.vente_btob_domestique %}‚úì B2B France<br>{% endif %}
                        {% if questionnaire_collaborateur.vente_btob_export %}‚úì B2B Export<br>{% endif %}
                        {% if questionnaire_collaborateur.vente_btoc_facture %}‚úì B2C avec facture<br>{% endif %}
                        {% if questionnaire_collaborateur.vente_btoc_caisse %}‚úì B2C avec ticket<br>{% endif %}
                    </dd>
                </dl>
            </div>

            <div class="questionnaire-section">
                <h3>Flux facturation - Achats</h3>
                <dl>
                    <dt>Nombre factures achats/an</dt>
                    <dd>{{ questionnaire_collaborateur.get_nb_factures_achats_display|default:"Non renseign√©" }}</dd>

                    <dt>Nombre fournisseurs actifs</dt>
                    <dd>{{ questionnaire_collaborateur.get_nb_fournisseurs_actifs_display|default:"Non renseign√©" }}</dd>

                    <dt>Types d'achats</dt>
                    <dd>
                        {% if questionnaire_collaborateur.achat_btob_domestique %}‚úì B2B France<br>{% endif %}
                        {% if questionnaire_collaborateur.achat_btob_intracommunautaire %}‚úì B2B UE<br>{% endif %}
                        {% if questionnaire_collaborateur.achat_btob_hors_ue %}‚úì B2B hors UE<br>{% endif %}
                    </dd>
                </dl>
            </div>

            {% if questionnaire_collaborateur.commentaires %}
            <div class="questionnaire-section">
                <h3>Observations</h3>
                <p>{{ questionnaire_collaborateur.commentaires }}</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Vue Synth√©tique -->
        {% if has_client and has_collaborateur %}
        <div id="tab-synthese" class="tab-content">
            <h2>Vue Synth√©tique</h2>
            <p class="info-text">Comparaison des informations client et collaborateur</p>

            <div class="synthese-grid">
                <!-- Plateforme agr√©√©e -->
                <div class="synthese-item">
                    <h4>üì± Plateforme agr√©√©e (Chorus Pro, etc.)</h4>
                    <div class="comparison">
                        <div class="comp-item">
                            <strong>Client:</strong> {{ questionnaire_client.get_plateforme_agreee_display }}
                            {% if questionnaire_client.plateforme_agreee_nom %}
                            <br><em>{{ questionnaire_client.plateforme_agreee_nom }}</em>
                            {% endif %}
                        </div>
                        <div class="comp-item">
                            <strong>Collaborateur:</strong> {{ questionnaire_collaborateur.plateforme_agreee|yesno:"Oui,Non" }}
                            {% if questionnaire_collaborateur.plateforme_agreee_nom %}
                            <br><em>{{ questionnaire_collaborateur.plateforme_agreee_nom }}</em>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Assujettissement TVA -->
                <div class="synthese-item">
                    <h4>üíº Assujettissement √† la TVA</h4>
                    <div class="comparison">
                        <div class="comp-item">
                            <strong>Client:</strong> Information non demand√©e
                        </div>
                        <div class="comp-item">
                            <strong>Collaborateur:</strong> {{ questionnaire_collaborateur.get_assujettie_tva_display }}
                        </div>
                    </div>
                </div>

                <!-- R√©gime TVA -->
                <div class="synthese-item">
                    <h4>üìã R√©gime de TVA</h4>
                    <div class="comparison">
                        <div class="comp-item">
                            <strong>Client:</strong> Information non demand√©e
                        </div>
                        <div class="comp-item">
                            <strong>Collaborateur:</strong> {{ questionnaire_collaborateur.get_regime_tva_display|default:"Non renseign√©" }}
                        </div>
                    </div>
                </div>

                <!-- Activit√© -->
                <div class="synthese-item">
                    <h4>üè¢ Activit√© de l'entreprise</h4>
                    <div class="comparison">
                        <div class="comp-item">
                            <strong>Client:</strong> Information non demand√©e
                        </div>
                        <div class="comp-item">
                            <strong>Collaborateur:</strong>
                            <br>Code APE: {{ questionnaire_collaborateur.code_ape|default:"Non renseign√©" }}
                            <br>{{ questionnaire_collaborateur.activite_precise|truncatewords:15 }}
                        </div>
                    </div>
                </div>

                <!-- Gestion de la facturation -->
                <div class="synthese-item">
                    <h4>‚öôÔ∏è Gestion de la facturation</h4>
                    <div class="comparison">
                        <div class="comp-item">
                            <strong>Client - Gestion future:</strong> {{ questionnaire_client.get_gestion_future_display|default:"Non renseign√©" }}
                            <br><strong>Aisance outils:</strong> {{ questionnaire_client.get_aisance_outils_display|default:"Non renseign√©" }}
                        </div>
                        <div class="comp-item">
                            <strong>Collaborateur - Taille:</strong> {{ questionnaire_collaborateur.get_taille_entreprise_display|default:"Non renseign√©" }}
                        </div>
                    </div>
                </div>

                <!-- Volumes - Ventes -->
                <div class="synthese-item">
                    <h4>üìà Volumes de facturation - Ventes</h4>
                    <div class="comparison">
                        <div class="comp-item">
                            <strong>Client:</strong> Information non demand√©e
                        </div>
                        <div class="comp-item">
                            <strong>Collaborateur:</strong>
                            <br>Factures/an: {{ questionnaire_collaborateur.get_nb_factures_ventes_display|default:"Non renseign√©" }}
                            <br>Clients actifs: {{ questionnaire_collaborateur.get_nb_clients_actifs_display|default:"Non renseign√©" }}
                        </div>
                    </div>
                </div>

                <!-- Volumes - Achats -->
                <div class="synthese-item">
                    <h4>üìâ Volumes de facturation - Achats</h4>
                    <div class="comparison">
                        <div class="comp-item">
                            <strong>Client:</strong> Information non demand√©e
                        </div>
                        <div class="comp-item">
                            <strong>Collaborateur:</strong>
                            <br>Factures/an: {{ questionnaire_collaborateur.get_nb_factures_achats_display|default:"Non renseign√©" }}
                            <br>Fournisseurs actifs: {{ questionnaire_collaborateur.get_nb_fournisseurs_actifs_display|default:"Non renseign√©" }}
                        </div>
                    </div>
                </div>

                <!-- √âquipement actuel -->
                <div class="synthese-item">
                    <h4>üíª √âquipement actuel du client</h4>
                    <div class="comparison single-col">
                        <div class="comp-item">
                            <strong>Logiciel de facturation:</strong> {{ questionnaire_client.logiciel_facturation|yesno:"Oui,Non" }}
                            {% if questionnaire_client.logiciel_facturation_nom %}
                            ({{ questionnaire_client.logiciel_facturation_nom }})
                            {% endif %}
                            <br><strong>Factures √©lectroniques:</strong> {{ questionnaire_client.get_factures_format_electronique_display|default:"Non renseign√©" }}
                            <br><strong>Logiciel de devis:</strong> {{ questionnaire_client.logiciel_devis|yesno:"Oui,Non" }}
                            {% if questionnaire_client.logiciel_devis_nom %}
                            ({{ questionnaire_client.logiciel_devis_nom }})
                            {% endif %}
                            <br><strong>Caisse enregistreuse:</strong> {{ questionnaire_client.get_caisse_enregistreuse_display|default:"Non renseign√©" }}
                            {% if questionnaire_client.caisse_enregistreuse_nom %}
                            ({{ questionnaire_client.caisse_enregistreuse_nom }})
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Flux et canaux -->
                <div class="synthese-item">
                    <h4>üîÑ Flux de r√©ception et envoi</h4>
                    <div class="comparison">
                        <div class="comp-item">
                            <strong>Client - R√©ception achats:</strong> {{ questionnaire_client.get_reception_factures_achats_display|default:"Non renseign√©" }}
                            <br><strong>Envoi ventes:</strong> {{ questionnaire_client.get_envoi_factures_ventes_display|default:"Non renseign√©" }}
                            <br><strong>Conservation:</strong> {{ questionnaire_client.get_conservation_factures_display|default:"Non renseign√©" }}
                        </div>
                        <div class="comp-item">
                            <strong>Collaborateur - Types de ventes:</strong>
                            <br>{{ questionnaire_collaborateur.vente_btob_domestique|yesno:"‚úì,‚úó" }} B2B France
                            <br>{{ questionnaire_collaborateur.vente_btob_export|yesno:"‚úì,‚úó" }} B2B Export
                            <br>{{ questionnaire_collaborateur.vente_btoc_facture|yesno:"‚úì,‚úó" }} B2C Facture
                            <br>{{ questionnaire_collaborateur.vente_btoc_caisse|yesno:"‚úì,‚úó" }} B2C Caisse
                        </div>
                    </div>
                </div>

                <!-- Accompagnement -->
                <div class="synthese-item">
                    <h4>ü§ù Accompagnement souhait√© par le client</h4>
                    <div class="comparison single-col">
                        <div class="comp-item">
                            {% if questionnaire_client.accompagnement_souhaite %}
                            {{ questionnaire_client.accompagnement_souhaite|join:", " }}
                            {% if questionnaire_client.accompagnement_autre %}
                            <br>Autre: {{ questionnaire_client.accompagnement_autre }}
                            {% endif %}
                            {% else %}
                            Non renseign√©
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="actions-card card">
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">
            ‚Üê Retour au dashboard
        </a>
    </div>
</div>

<script>
function showTab(tabName) {
    // Masquer tous les contenus
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => content.classList.remove('active'));

    // D√©sactiver tous les boutons
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => btn.classList.remove('active'));

    // Activer le contenu et le bouton s√©lectionn√©s
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
}
</script>
{% endblock %}
