{% extends 'base.html' %}
{% load static %}

{% block title %}Identification - Questionnaire Client{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'questionnaires/css/identification.css' %}">
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block content %}
<div class="identification-container">
    <div class="card">
        <h1>Identification de votre entreprise</h1>

        <p class="intro-text">
            Pour commencer, veuillez saisir le numéro SIREN de votre entreprise.
            Nous récupérerons automatiquement les informations de votre société.
        </p>

        <form method="post" class="identification-form">
            {% csrf_token %}

            <div class="form-group">
                <label for="siren">Numéro SIREN <span class="required">*</span></label>
                <input
                    type="text"
                    id="siren"
                    name="siren"
                    pattern="[0-9]{9}"
                    maxlength="9"
                    placeholder="9 chiffres"
                    value="{{ siren|default:'' }}"
                    required
                    hx-get="{% url 'validate_siren' %}"
                    hx-trigger="keyup changed delay:500ms, blur"
                    hx-target="#company-name"
                    hx-indicator="#spinner"
                    hx-include="[name='siren']"
                >
                <small class="form-help">Le SIREN est un numéro à 9 chiffres qui identifie votre entreprise</small>

                <div id="spinner" class="htmx-indicator">
                    <span class="spinner"></span> Vérification en cours...
                </div>

                <div id="company-name"></div>

                <label for="cabinet">Selectionner votre cabinet <span class="required">*</span></label>
                <select name="cabinet" 
                        id="cabinet"
                        required
                        hx-get="{% url 'get_comptables' %}"
                        hx-trigger="change"
                        hx-target="#select-comptable"
                        hx-include="[name='cabinet']"
                >
                    <option value="">-- Sélectionner votre cabinet --</option>
                    {% for cabinet in cabinets %}
                        <option value="{{ cabinet.id }}">{{ cabinet.nom }}</option>
                    {% endfor %}
                </select>

                <label for="comptable">Selectionner votre comptable <span class="required">*</span></label>
                <select name="comptable"
                        id="select-comptable"
                        required
                        >
                    <option value="">-- Sélectionner d'abord un cabinet --</option>    
                </select>
            </div>

            {% if questionnaire_exists %}
            <div class="alert alert-warning">
                <strong>⚠️ Un questionnaire existe déjà pour cette entreprise :</strong>
                <p>{{ nom_entreprise }} (SIREN: {{ siren }})</p>
                <p>Souhaitez-vous le modifier ?</p>

                <div class="btn-group">
                    <button type="submit" name="action" value="modifier" class="btn btn-primary">
                        Modifier le questionnaire
                    </button>
                    <a href="{% url 'home' %}" class="btn btn-secondary">
                        Annuler
                    </a>
                </div>
            </div>
            {% else %}
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    Continuer
                </button>
                <a href="{% url 'client_introduction' %}" class="btn btn-secondary">
                    Retour
                </a>
            </div>
            {% endif %}
        </form>

    </div>
</div>
{% endblock %}
